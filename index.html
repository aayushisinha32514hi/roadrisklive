<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RoadRiskLive ‚Äî Demo</title>

  <!-- Google font (for nicer UI) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{
      --bg: #f7f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0b76ef;
      --accent-2: #00a86b;
      --danger: #e53e3e;
      --radius: 12px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:#111;}
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px; background:linear-gradient(90deg,#fff,#fafbff);
      border-bottom:1px solid rgba(0,0,0,0.04);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      height:38px; width:38px; border-radius:10px; background:linear-gradient(135deg,#0b76ef,#00a86b);
      display:flex; align-items:center; justify-content:center; color:white; font-weight:700;
      box-shadow:0 4px 14px rgba(11,118,239,0.12);
    }
    .title{ font-weight:600; font-size:16px; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:-4px; }

    /* container */
    .container{ display:flex; flex-direction:column; height:calc(100% - 62px); gap:10px; padding:10px; box-sizing:border-box; }

    /* map */
    #map { height:56vh; border-radius:10px; box-shadow:0 6px 18px rgba(12,24,56,0.06); border:1px solid rgba(0,0,0,0.03); }

    /* control panel */
    .panel{
      margin-top:6px; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;
    }
    .left, .right { background:var(--card); padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(12,24,56,0.04); }
    .left { flex:1; min-width:200px; }
    .right { width:340px; min-width:220px; }

    /* buttons */
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .btn {
      background:white; border:1px solid rgba(0,0,0,0.08); padding:8px 12px; border-radius:10px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; font-weight:600; color:#111;
    }
    .btn.primary { background:var(--accent); color:white; border:0; box-shadow:0 6px 18px rgba(11,118,239,0.12); }
    .btn.ghost { background:#fff; }
    .btn.danger { background:var(--danger); color:white; border:0; }

    /* details */
    .details { font-size:15px; color:#111; line-height:1.5; }
    .details b { color:#111; }
    .muted { color:var(--muted); font-size:13px; margin-top:6px; }

    /* center button small */
    #centerBtn { padding:6px 10px; font-size:13px; }

    /* responsive */
    @media (max-width:720px){
      .container{ padding:8px; }
      #map{ height:60vh; }
      .panel{ flex-direction:column; }
      .right{ width:100%; }
    }

  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">R</div>
      <div>
        <div class="title">RoadRiskLive</div>
        <div class="subtitle">Real-time road condition & risk monitoring</div>
      </div>
    </div>
    <div style="margin-left:auto; color:var(--muted); font-size:13px;">Demo ‚Ä¢ Live</div>
  </div>

  <div class="container">
    <div id="map"></div>

    <div class="panel">
      <div class="left">
        <div class="controls">
          <button id="reportBtn" class="btn"><span>üìç</span> Report my location</button>
          <button id="startSensorsBtn" class="btn primary">‚ñ∂Ô∏è Start live sensors</button>
          <button id="stopSensorsBtn" class="btn" style="display:none">‚èπ Stop sensors</button>
          <button id="centerBtn" class="btn ghost" title="Center map to marker">üìå Center map</button>
        </div>

        <div class="muted">Status</div>
        <div id="status" style="margin-top:6px; font-weight:600;">Waiting for action‚Ä¶</div>

        <div style="height:8px"></div>

        <div class="muted">Controls</div>
        <div class="muted" style="margin-top:6px">Tap <b>Start live sensors</b> then allow location and motion on your phone.</div>
      </div>

      <div class="right">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-weight:700">Live data</div>
          <div style="color:var(--muted); font-size:13px">Realtime ‚Ä¢ Firebase</div>
        </div>

        <div class="details" id="details">
          No data yet ‚Äî use <b>Report my location</b> to send a quick location.
        </div>

        <div style="height:8px"></div>
        <div class="muted">Last pushed</div>
        <div id="lastPushed" style="font-weight:600; margin-top:6px;">‚Äî</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  // --------- FIREBASE CONFIG (v8 namespaced) ----------
  var firebaseConfig = {
    apiKey: "AIzaSyA0tYEv8JNnjOFRAShK5kWfuvmr6mW33w0",
    authDomain: "roadrisklive.firebaseapp.com",
    databaseURL: "https://roadrisklive-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "roadrisklive",
    storageBucket: "roadrisklive.firebasestorage.app",
    messagingSenderId: "986539291256",
    appId: "1:986539291256:web:ef4f5ab28c214c18af338d"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();
  var ref = db.ref("live_area");

  // --------- MAP SETUP ----------
  var map = L.map('map').setView([28.47,77.50], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  var marker = null;

  function showDetails(p){
    if(!p) { document.getElementById('details').innerText = "No area data"; return; }
    var html =
      "<b>Risk Score:</b> " + (p.risk_score||0) + "<br>" +
      "<b>Acceleration:</b> " + (p.acc||p.acceleration||0) + "<br>" +
      "<b>Pothole:</b> " + p.pothole + "<br>" +
      "<b>Rough:</b> " + p.rough + "<br>" +
      "<b>Visibility:</b> " + (p.visibility||'') + "<br>" +
      "<b>Timestamp:</b> " + (p.timestamp||'') + "<br>" +
      "<b>Lat:</b> " + (p.lat||'') + " <b>Lon:</b> " + (p.lon||'');
    document.getElementById('details').innerHTML = html;
  }

  // Live listener ‚Äî update marker and details only (NO auto-recenter)
  ref.on("value", function(snapshot){
    var d = snapshot.val();
    if(!d) return;
    // remove previous marker
    if(marker) map.removeLayer(marker);

    // color by risk (still simple: green for now)
    var color = d.risk_score > 70 ? "red" : d.risk_score > 40 ? "orange" : "green";
    marker = L.circleMarker([d.lat, d.lon], { radius: 12, color: color, fillOpacity: 0.9 }).addTo(map);

    // small popup for quick info
    marker.bindPopup("Risk: " + (d.risk_score||0) + " ‚Ä¢ Acc: " + (d.acc||0)).openPopup();

    // show details panel
    showDetails(d);

    // update last pushed
    document.getElementById('lastPushed').innerText = d.timestamp || new Date().toISOString();
    document.getElementById('status').innerText = "LIVE (last update shown below)";
  }, function(err){ console.error("firebase error",err); });

  // ---------- helpers ----------
  function computeRisk(acceleration, visibility=5){
    var pothole = acceleration > 5.0;
    var rough = acceleration > 3.0;
    var risk = 0;
    if(pothole) risk += 50;
    if(rough) risk += 30;
    if(visibility < 4) risk += 20;
    return {risk: Math.round(risk), pothole: pothole, rough: rough};
  }

  function pushToFirebase(payload){
    ref.set(payload).then(function(){ 
      document.getElementById('status').innerText = "Last pushed: " + (payload.timestamp||new Date().toISOString());
    }).catch(function(e){
      document.getElementById('status').innerText = "Push error: " + e;
    });
  }

  // ---------- UI controls ----------
  document.getElementById('reportBtn').addEventListener('click', function(){
    if(!navigator.geolocation){ alert("Geolocation not supported"); return; }
    document.getElementById('status').innerText = "Getting current GPS...";
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;
      var ts = new Date().toISOString();
      var acc = 0;
      var vis = 5;
      var r = computeRisk(acc, vis);
      var payload = {
        lat: lat, lon: lon, acc: acc, pothole: r.pothole, rough: r.rough,
        visibility: vis, risk_score: r.risk, timestamp: ts
      };
      pushToFirebase(payload);
    }, function(err){
      alert("GPS error: " + err.message);
      document.getElementById('status').innerText = "GPS error";
    }, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 });
  });

  // ---------- sensors ----------
  var motionHandler = null;
  var lastAccel = 0;
  var sensorInterval = null;

  async function startSensors(){
    // request motion permission on iOS
    try {
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        let perm = await DeviceMotionEvent.requestPermission();
        if (perm !== 'granted') {
          alert('Motion permission denied. Accelerometer will not be available.');
        }
      }
    } catch(e){
      console.log('DeviceMotion request error', e);
    }

    if(!navigator.geolocation) { alert("Geolocation not supported"); return; }

    document.getElementById('startSensorsBtn').style.display = 'none';
    document.getElementById('stopSensorsBtn').style.display = 'inline-block';
    document.getElementById('status').innerText = "Sensors started. Capturing location + acceleration.";

    motionHandler = function(ev){
      var a = ev.acceleration || ev.accelerationIncludingGravity || {x:0,y:0,z:0};
      var ax = a.x || 0, ay = a.y || 0, az = a.z || 0;
      lastAccel = Math.sqrt(ax*ax + ay*ay + az*az);
    };
    window.addEventListener('devicemotion', motionHandler);

    sensorInterval = setInterval(function(){
      navigator.geolocation.getCurrentPosition(function(pos){
        var lat = pos.coords.latitude;
        var lon = pos.coords.longitude;
        var ts = new Date().toISOString();
        var acc = Math.round(lastAccel * 10)/10;
        var vis = 5;
        var r = computeRisk(acc, vis);
        var payload = { lat:lat, lon:lon, acc:acc, pothole:r.pothole, rough:r.rough, visibility:vis, risk_score:r.risk, timestamp:ts };
        pushToFirebase(payload);
      }, function(err){
        console.warn("GPS error while running sensors:", err);
        document.getElementById('status').innerText = "GPS error while sensors running: " + err.message;
      }, { enableHighAccuracy:true, maximumAge:1000, timeout:5000 });
    }, 1000);
  }

  function stopSensors(){
    if(motionHandler) window.removeEventListener('devicemotion', motionHandler);
    if(sensorInterval){ clearInterval(sensorInterval); sensorInterval = null; }
    document.getElementById('startSensorsBtn').style.display = 'inline-block';
    document.getElementById('stopSensorsBtn').style.display = 'none';
    document.getElementById('status').innerText = "Sensors stopped.";
  }

  document.getElementById('startSensorsBtn').addEventListener('click', startSensors);
  document.getElementById('stopSensorsBtn').addEventListener('click', stopSensors);

  // center button
  document.getElementById('centerBtn').addEventListener('click', function(){
    if(marker) map.setView(marker.getLatLng(), 17);
  });

  </script>
</body>
</html>