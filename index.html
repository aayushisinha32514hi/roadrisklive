<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RoadRiskLive ‚Äî demo</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --card:#ffffff; --muted:#6b7280; --accent:#0b76ef; --success:#168a46;
    --panel-radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;}
  .app{max-width:960px;margin:10px auto;padding:14px;}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,#2DD4BF,#3B82F6);color:white;display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{margin:0;font-size:20px}
  .small{color:var(--muted);font-size:13px}
  #map{height:180px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden;margin-top:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #ececec;background:#fff;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white;border:0}
  .panel{background:var(--card);border-radius:var(--panel-radius);padding:14px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  .live-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #eee}
  .live-row:last-child{border-bottom:0}
  .label{color:var(--muted)}
  .value{font-weight:700}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
  .summary{margin-top:14px}
  .summary table{width:100%;border-collapse:collapse}
  .summary th,.summary td{padding:8px;text-align:left;border-bottom:1px solid #f0f0f0}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  /* mobile-friendly */
  @media(min-width:900px){ #map{height:300px} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">R</div>
    <div>
      <h1>RoadRiskLive</h1>
      <div class="small">Realtime road condition & risk monitoring ‚Äî demo</div>
    </div>
  </header>

  <div id="map" aria-hidden="false"></div>

  <div class="controls">
    <button id="reportBtn">üìç Report my location</button>
    <button id="startBtn" class="btn-primary">‚ñ∂Ô∏è Start live sensors</button>
    <button id="stopBtn" disabled>‚èπ Stop sensors</button>
    <button id="centerBtn">üìå Center map</button>
    <!-- quick simulate button (for testing UI without sensors) -->
    <button id="simulateBtn">‚ö° Simulate payload</button>
  </div>

  <div class="panel">
    <div class="small">Live data ¬∑ Demo</div>
    <div id="lastPushed" class="small" style="margin-top:8px">Last pushed: ‚Äî</div>

    <div style="margin-top:12px">
      <div class="live-row"><div class="label">Risk Score</div><div id="risk" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Acceleration</div><div id="acc" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Pothole</div><div id="pothole" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Rough</div><div id="rough" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Visibility</div><div id="vis" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Timestamp</div><div id="ts" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Lat</div><div id="lat" class="value">‚Äî</div></div>
      <div class="live-row"><div class="label">Lon</div><div id="lon" class="value">‚Äî</div></div>
    </div>

    <div class="summary">
      <div class="small">Quick interpretation</div>
      <table>
        <tr><th>Metric</th><th>Meaning / Notes</th></tr>
        <tr><td>Risk Score</td><td>0 = safe (higher = more risk)</td></tr>
        <tr><td>Acceleration</td><td>High ‚âà bump/impact</td></tr>
        <tr><td>Pothole</td><td>Counts potholes reported: Yes / No</td></tr>
        <tr><td>Rough</td><td>Surface roughness flag: Yes / No</td></tr>
        <tr><td>Visibility</td><td>1 (low) ‚Üí 5 (good)</td></tr>
      </table>
    </div>
  </div>
</div>

<script>
/* --------- helper & debug --------- */
console.log('[RR] index.html loaded');

const el = id => document.getElementById(id);
const setText = (id, txt) => { const e = el(id); if(e) e.innerText = (txt===undefined||txt===null)?'‚Äî':txt; };

/* --------- init map + marker --------- */
let map = L.map('map',{ zoomControl:true }).setView([28.45006,77.58585], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬©Ô∏è OpenStreetMap' }).addTo(map);
let marker = L.circleMarker([28.45006,77.58585], { radius:10, color: '#168a46', fillColor:'#168a46', fillOpacity:1 }).addTo(map);

/* --------- UI updater (single place to call) --------- */
function updateUIFromPayload(p){
  // p: { timestamp, lat, lon, acceleration, pothole, rough, visibility, risk }
  setText('risk', p.risk ?? '‚Äî');
  // acceleration numeric -> show numeric (or dash)
  setText('acc', (p.acceleration === undefined || p.acceleration === null) ? '‚Äî' : String(Number(p.acceleration).toFixed(2)));
  // boolean fields -> Yes / No
  setText('pothole', (p.pothole === undefined || p.pothole === null) ? '‚Äî' : (p.pothole ? 'Yes' : 'No'));
  setText('rough', (p.rough === undefined || p.rough === null) ? '‚Äî' : (p.rough ? 'Yes' : 'No'));
  setText('vis', (p.visibility === undefined || p.visibility === null) ? '‚Äî' : (p.visibility));
  setText('ts', p.timestamp ?? '‚Äî');
  setText('lat', (p.lat === undefined || p.lat === null) ? '‚Äî' : (Number(p.lat).toFixed(6)));
  setText('lon', (p.lon === undefined || p.lon === null) ? '‚Äî' : (Number(p.lon).toFixed(6)));
  // update marker if lat/lon exist
  if(p.lat !== undefined && p.lon !== undefined && p.lat !== null && p.lon !== null){
    try{ marker.setLatLng([Number(p.lat), Number(p.lon)]); map.setView([Number(p.lat), Number(p.lon)], 16); } catch(e){ console.warn('[RR] marker update failed', e); }
  }
  // last pushed
  setText('lastPushed', p.timestamp ?? new Date().toISOString());
  // store last payload in window for debug
  window.__lastPayload = p;
}

/* --------- sensors handling --------- */
let motionHandler = null;
let sensorsRunning = false;

function setButtonsRunning(r){
  sensorsRunning = r;
  el('startBtn').disabled = r;
  el('stopBtn').disabled = !r;
}

async function startLiveSensors(){
  console.log('[RR] startLiveSensors called');
  setButtonsRunning(true);
  setText('lastPushed', 'Getting sensors...');

  // Request device motion permission on iOS (must be via gesture)
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    try{
      const perm = await DeviceMotionEvent.requestPermission();
      console.log('[RR] DeviceMotion permission:', perm);
      if(perm !== 'granted'){ alert('Motion permission not granted ‚Äî motion data disabled'); }
    } catch(e){ console.warn('[RR] DeviceMotion request error', e); }
  }

  // attach motion handler (best-effort)
  motionHandler = (ev) => {
    try{
      const ax = (ev.acceleration?.x ?? ev.accelerationIncludingGravity?.x) ?? 0;
      const ay = (ev.acceleration?.y ?? ev.accelerationIncludingGravity?.y) ?? 0;
      const az = (ev.acceleration?.z ?? ev.accelerationIncludingGravity?.z) ?? 0;
      const acc = Math.sqrt(ax*ax + ay*ay + az*az);
      // update only acceleration field so UI becomes responsive
      updateUIFromPayload({ acceleration: Number(acc.toFixed(2)), timestamp: new Date().toISOString() , lat: window.__lastPayload?.lat, lon: window.__lastPayload?.lon });
      console.log('[RR] motion acc=', acc);
    } catch(e){ console.warn('[RR] motion handler error', e); }
  };
  try{ window.addEventListener('devicemotion', motionHandler); } catch(e){ console.warn('[RR] addEventListener devicemotion failed', e); }

  // then get geolocation once (and show a simulated payload to show all UI elements)
  if(!navigator.geolocation){
    alert('Geolocation not supported in this browser');
    setText('lastPushed','No geolocation');
    setButtonsRunning(false);
    return;
  }

  navigator.geolocation.getCurrentPosition((pos) => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    console.log('[RR] got geo', lat, lon);
    // construct demo payload (you can replace this part to push to DB later)
    const payload = {
      timestamp: new Date().toISOString(),
      lat, lon,
      acceleration: window.__lastPayload?.acceleration ?? 0,
      pothole: false,
      rough: false,
      visibility: 5,
      risk: 0
    };
    updateUIFromPayload(payload);
    setText('lastPushed','Live (last update shown below)');
  }, (err) => {
    console.warn('[RR] geolocation error', err);
    setText('lastPushed','Geo error: ' + (err.message || err.code || 'unknown'));
    setButtonsRunning(false);
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:10000 });
}

function stopLiveSensors(){
  console.log('[RR] stopLiveSensors called');
  if(motionHandler) window.removeEventListener('devicemotion', motionHandler);
  motionHandler = null;
  setButtonsRunning(false);
  setText('lastPushed','Stopped');
}

/* Report current device location (on button press) */
function reportMyLocation(){
  console.log('[RR] reportMyLocation() called');
  if(!navigator.geolocation){ alert('No geolocation'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const payload = { timestamp: new Date().toISOString(), lat, lon, acceleration: window.__lastPayload?.acceleration ?? 0, pothole:false, rough:false, visibility:5, risk:0 };
    // update UI only (demo)
    updateUIFromPayload(payload);
    console.log('[RR] reported payload (demo only)', payload);
  }, (err) => { console.warn('[RR] report geo error', err); alert('Location failed: ' + (err.message||err.code)); }, { enableHighAccuracy:true, timeout:10000 });
}

function centerMap(){
  console.log('[RR] centerMap()');
  const lat = parseFloat(el('lat').innerText) || 28.45006;
  const lon = parseFloat(el('lon').innerText) || 77.58585;
  map.setView([lat,lon], 16);
}

/* --------- debug: wrap original functions so logs appear in console if we override later --------- */
console.log('[RR] hooking buttons & UI');
el('startBtn').addEventListener('click', startLiveSensors);
el('stopBtn').addEventListener('click', stopLiveSensors);
el('reportBtn').addEventListener('click', reportMyLocation);
el('centerBtn').addEventListener('click', centerMap);

/* Simulate button ‚Äî helpful to test UI quickly */
el('simulateBtn').addEventListener('click', ()=> {
  const fake = {
    timestamp: new Date().toISOString(),
    lat: 28.45006 + (Math.random()-0.5)/1000,
    lon: 77.58585 + (Math.random()-0.5)/1000,
    acceleration: Number((Math.random()*1.5).toFixed(2)),
    pothole: Math.random() > 0.75,
    rough: Math.random() > 0.6,
    visibility: Math.ceil(Math.random()*5),
    risk: Math.floor(Math.random()*30)
  };
  console.log('[RR] simulate payload ->', fake);
  updateUIFromPayload(fake);
});

/* initial UI */
setText('lastPushed','‚Äî');
console.log('[RR] demo UI wired - ready.');
</script>
</body>
</html>