<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RoadRiskLive ‚Äî demo</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0b76ef;
      --success:#16a34a;
      --panel-radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;}
    .app{max-width:920px;margin:12px auto;padding:12px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#2DD4BF,#3B82F6);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0;font-size:18px}
    .small{color:var(--muted);font-size:13px}

    #map{height:170px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden;margin-bottom:12px}

    .controls{display:flex;gap:8px;flex-wrap:wrap;padding:12px 0}
    button{padding:10px 14px;border-radius:12px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white;border:0}
    button:disabled{opacity:.5;cursor:not-allowed}

    .panel{background:var(--card);border-radius:var(--panel-radius);padding:14px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .live-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #eee}
    .live-row:last-child{border-bottom:0}
    .label{color:var(--muted)}
    .value{font-weight:700}

    .summary{margin-top:12px}
    .summary table{width:100%;border-collapse:collapse}
    .summary th,.summary td{padding:8px;text-align:left;border-bottom:1px solid #f0f0f0}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}

    /* responsive */
    @media(min-width:900px){ #map{height:300px} }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="logo">R</div>
      <div>
        <h1>RoadRiskLive</h1>
        <div class="small">Realtime road condition &amp; risk monitoring ‚Äî demo</div>
      </div>
    </header>

    <div id="map" aria-hidden="false"></div>

    <div class="controls">
      <button id="reportBtn">üìç Report my location</button>
      <button id="startBtn" class="btn-primary">‚ñ∂Ô∏è Start live sensors</button>
      <button id="stopBtn" disabled>‚èπ Stop sensors</button>
      <button id="centerBtn">üìå Center map</button>

      <!-- visibility input for demo -->
      <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px">
        Visibility:
        <select id="visInput" style="padding:8px;border-radius:8px;margin-left:6px">
          <option value="5">5 (Good)</option>
          <option value="4">4</option>
          <option value="3">3</option>
          <option value="2">2</option>
          <option value="1">1 (Poor)</option>
        </select>
      </label>

      <button id="simulateBtn" style="margin-left:6px">‚ö° Simulate payload</button>
    </div>

    <div class="panel">
      <div class="small">Live data ¬∑ Demo</div>
      <div id="lastPushed" class="small" style="margin-top:8px;color:var(--muted);font-weight:600">Last pushed: ‚Äî</div>

      <div style="margin-top:12px">
        <div class="live-row"><div class="label">Risk Score</div><div id="risk" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Acceleration</div><div id="acc" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Pothole</div><div id="pothole" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Rough</div><div id="rough" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Visibility</div><div id="vis" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Timestamp</div><div id="ts" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Lat</div><div id="lat" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Lon</div><div id="lon" class="value">‚Äî</div></div>
      </div>

      <div class="summary">
        <div class="small">Quick interpretation</div>
        <table>
          <tr><th>Metric</th><th>Meaning / Notes</th></tr>
          <tr><td>Risk Score</td><td class="value">Higher = more dangerous (0 = safe)</td></tr>
          <tr><td>Acceleration</td><td class="value">High ‚âà bump/impact</td></tr>
          <tr><td>Pothole</td><td class="value">Yes = detected (impact spike)</td></tr>
          <tr><td>Rough</td><td class="value">Yes = sustained rough surface</td></tr>
          <tr><td>Visibility</td><td class="value">1 (low) ‚Üí 5 (good) (manually set)</td></tr>
        </table>
      </div>
    </div>
  </div>

  <script>
  /* --------------- FULL DEMO SCRIPT ---------------
     Single-file demo. Works offline for UI and map.
     DeviceMotion requires user gesture (Start live sensors).
     Geolocation requests permission and works over HTTPS.
  -------------------------------------------------*/

  console.log('[RR] demo script loaded');

  const el = id => document.getElementById(id);

  // --- init map & marker
  const DEFAULT = { lat: 28.45006, lon: 77.58585 }; // Noida demo
  let map = L.map('map', { zoomControl: true }).setView([DEFAULT.lat, DEFAULT.lon], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '¬©Ô∏è OpenStreetMap'
  }).addTo(map);
  let marker = L.circleMarker([DEFAULT.lat, DEFAULT.lon], { radius: 10, color:'#168a46', fillColor:'#168a46', fillOpacity:1 }).addTo(map);
  marker.bindPopup('No data yet');

  // UI helpers
  const setText = (id, t) => { const e = el(id); if(e) e.innerText = t; };

  // sensor handling
  let motionHandler = null;
  let sensorsRunning = false;
  let geoInterval = null;

  // acceleration rolling buffer
  const ACC_BUFFER_LEN = 6;
  let accBuffer = [];

  function setButtonsRunning(r){
    sensorsRunning = r;
    el('startBtn').disabled = r;
    el('stopBtn').disabled = !r;
  }

  // utility: set multiple fields from payload
  function updateUIFromPayload(p){
    // p = { timestamp, lat, lon, acceleration, pothole, rough, visibility, risk }
    setText('risk', (p.risk !== undefined) ? p.risk.toFixed(0) : '‚Äî');
    setText('acc', (p.acceleration !== undefined) ? Number(p.acceleration).toFixed(2) : '‚Äî');
    setText('pothole', (p.pothole ? 'Yes' : (p.pothole===false ? 'No' : '‚Äî')));
    setText('rough', (p.rough ? 'Yes' : (p.rough===false ? 'No' : '‚Äî')));
    setText('vis', (p.visibility !== undefined) ? p.visibility : '‚Äî');
    setText('ts', p.timestamp ?? '‚Äî');
    setText('lat', (p.lat !== undefined) ? (Number(p.lat).toFixed(6)) : '‚Äî');
    setText('lon', (p.lon !== undefined) ? (Number(p.lon).toFixed(6)) : '‚Äî');
  }

  // Risk calculation described in the explanation:
  function computeRisk({acceleration=0, pothole=false, rough=false, visibility=5}){
    // acceleration contribution
    let accPart = Math.min(40, acceleration * 10); // scaled
    let potholePart = pothole ? 30 : 0;
    let roughPart = rough ? 20 : 0;
    const visPenalty = {5:0,4:2,3:4,2:6,1:8}[visibility] ?? 0;
    let risk = accPart + potholePart + roughPart + visPenalty;
    if(risk < 0) risk = 0;
    if(risk > 100) risk = 100;
    return Math.round(risk);
  }

  // Determine pothole: acceleration spike threshold
  const POTHOLE_THRESHOLD = 2.5; // m/s^2 ‚Äî tweak if needed
  const ROUGH_AVG_THRESHOLD = 1.0; // average accel over buffer

  function analyzeAcceleration(accVal){
    // push to buffer
    accBuffer.push(accVal);
    if(accBuffer.length > ACC_BUFFER_LEN) accBuffer.shift();
    // compute rolling average
    const avg = accBuffer.length ? (accBuffer.reduce((a,b)=>a+b,0)/accBuffer.length) : 0;
    // pothole if current acc spike > threshold
    const pothole = (accVal >= POTHOLE_THRESHOLD);
    const rough = (avg >= ROUGH_AVG_THRESHOLD);
    return {acc:accVal, avg, pothole, rough};
  }

  // Start live sensors
  async function startLiveSensors(){
    console.log('[RR] startLiveSensors called');
    setButtonsRunning(true);
    setText('lastPushed','Getting sensors...');
    // ask for iOS DeviceMotion permission if required
    try {
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        const perm = await DeviceMotionEvent.requestPermission();
        console.log('[RR] DeviceMotion permission:', perm);
        if (perm !== 'granted') {
          alert('Motion permission not granted ‚Äî motion data will be disabled.');
        }
      }
    } catch(e){
      console.warn('[RR] DeviceMotion request error', e);
    }

    // attach motion handler (best-effort)
    motionHandler = (ev) => {
      try {
        const ax = (ev.acceleration?.x ?? ev.accelerationIncludingGravity?.x ?? 0);
        const ay = (ev.acceleration?.y ?? ev.accelerationIncludingGravity?.y ?? 0);
        const az = (ev.acceleration?.z ?? ev.accelerationIncludingGravity?.z ?? 0);
        const acc = Math.sqrt(ax*ax + ay*ay + az*az);
        // update accel UI quickly
        const analysis = analyzeAcceleration(Number(acc));
        // read visibility selection
        const visibility = Number(el('visInput').value);
        // compute risk (we will not include DB here)
        const risk = computeRisk({acceleration: analysis.acc, pothole: analysis.pothole, rough: analysis.rough, visibility});
        // quick UI update
        updateUIFromPayload({
          acceleration: Number(analysis.acc).toFixed(2),
          pothole: analysis.pothole,
          rough: analysis.rough,
          visibility,
          risk,
          timestamp: new Date().toISOString(),
          lat: parseFloat(el('lat').innerText) || DEFAULT.lat,
          lon: parseFloat(el('lon').innerText) || DEFAULT.lon,
        });
        // update marker popup
        marker.setPopupContent(`Risk: ${risk} ‚Ä¢ Acc: ${Number(analysis.acc).toFixed(2)}`).openPopup();
      } catch(err){ console.warn('[RR] motion handler error', err); }
    };
    window.addEventListener('devicemotion', motionHandler);

    // get geolocation once and then poll periodically
    if (!navigator.geolocation){
      alert('Geolocation not supported in this browser');
      setText('lastPushed','No geolocation');
      return;
    }

    // small helper to get position and update UI + marker
    function doGeoOnce(){
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        console.log('[RR] got geo', lat, lon);
        marker.setLatLng([lat, lon]);
        map.setView([lat, lon], 16);
        // simulate payload to update UI fields (acceleration will come from motion)
        const payload = {
          timestamp: new Date().toISOString(),
          lat, lon,
          acceleration: Number(el('acc').innerText) ? Number(el('acc').innerText) : 0,
          pothole: (el('pothole').innerText === 'Yes'),
          rough: (el('rough').innerText === 'Yes'),
          visibility: Number(el('visInput').value),
          risk: Number(el('risk').innerText) || 0
        };
        updateUIFromPayload(payload);
        setText('lastPushed','Live: ' + payload.timestamp);
      }, (err) => {
        console.warn('[RR] geolocation error', err);
        setText('lastPushed','Geo error: ' + (err.message || err.code));
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:10000});
    }

    // run once, then poll every 2s
    doGeoOnce();
    if(geoInterval) clearInterval(geoInterval);
    geoInterval = setInterval(doGeoOnce, 2000);
  }

  function stopLiveSensors(){
    console.log('[RR] stopLiveSensors called');
    if (motionHandler) window.removeEventListener('devicemotion', motionHandler);
    motionHandler = null;
    if (geoInterval) { clearInterval(geoInterval); geoInterval = null; }
    setButtonsRunning(false);
    setText('lastPushed','Stopped');
  }

  // get geolocation and update UI (Report my location)
  function reportMyLocation(){
    console.log('[RR] reportMyLocation() called');
    if (!navigator.geolocation){ alert('No geolocation'); return; }
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const payload = { timestamp: new Date().toISOString(), lat, lon };
      marker.setLatLng([lat, lon]); map.setView([lat, lon], 16);
      updateUIFromPayload({ timestamp: payload.timestamp, lat, lon, visibility: Number(el('visInput').value) });
      setText('lastPushed','Reported location: ' + payload.timestamp);
      console.log('[RR] reported payload (demo only)', payload);
    }, (err) => {
      console.warn('[RR] report geo error', err);
      alert('Location failed: ' + (err.message || err.code));
    });
  }

  // center map on last known lat/lon in UI
  function centerMap(){
    console.log('[RR] centerMap()');
    const lat = parseFloat(el('lat').innerText) || DEFAULT.lat;
    const lon = parseFloat(el('lon').innerText) || DEFAULT.lon;
    map.setView([lat, lon], 16);
  }

  // Simulate payload (useful for demo without motion sensors)
  function simulatePayload(){
    // create a small random acceleration pattern
    const acc = (Math.random() * 2.5).toFixed(2);
    // push to buffer so rough detection works
    analyzeAcceleration(Number(acc));
    const visibility = Number(el('visInput').value);
    const pothole = (Number(acc) >= POTHOLE_THRESHOLD);
    const rough = (accBuffer.reduce((a,b)=>a+b,0)/accBuffer.length) >= ROUGH_AVG_THRESHOLD;
    const risk = computeRisk({acceleration:Number(acc), pothole, rough, visibility});
    // fake a location slightly jittered from current marker
    const cur = marker.getLatLng();
    const lat = cur.lat + (Math.random()-0.5)*0.0003;
    const lon = cur.lng + (Math.random()-0.5)*0.0003;
    marker.setLatLng([lat, lon]);
    map.setView([lat, lon], 16);
    const payload = {
      timestamp: new Date().toISOString(),
      lat, lon,
      acceleration: Number(acc),
      pothole, rough, visibility, risk
    };
    updateUIFromPayload(payload);
    setText('lastPushed','Simulated push at ' + payload.timestamp);
    marker.setPopupContent(`Risk: ${risk} ‚Ä¢ Acc: ${Number(acc).toFixed(2)}`).openPopup();
    console.log('[RR] simulated payload', payload);
  }

  // Wire buttons
  el('startBtn').addEventListener('click', startLiveSensors);
  el('stopBtn').addEventListener('click', stopLiveSensors);
  el('reportBtn').addEventListener('click', reportMyLocation);
  el('centerBtn').addEventListener('click', centerMap);
  el('simulateBtn').addEventListener('click', simulatePayload);

  // initial UI
  setText('lastPushed','‚Äî');
  console.log('[RR] demo UI wired - ready.');
  </script>
</body>
</html>