<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RoadRiskLive ‚Äî demo (test build)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0b76ef;
      --success:#16a34a;
      --panel-radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;}
    .app{max-width:920px;margin:12px auto;padding:12px;}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#2DD4BF,#3B82F6);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0;font-size:18px}
    #map{height:170px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden}
    .controls{display:flex;gap:8px;flex-wrap:wrap;padding:12px 0}
    button{padding:10px 14px;border-radius:12px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white;border:0}
    .panel{background:var(--card);border-radius:var(--panel-radius);padding:14px;margin-top:14px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .live-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #eee;align-items:center}
    .live-row:last-child{border-bottom:0}
    .label{color:var(--muted)}
    .value{font-weight:700}
    .summary{margin-top:12px}
    .summary table{width:100%;border-collapse:collapse}
    .summary th,.summary td{padding:8px;text-align:left;border-bottom:1px solid #f0f0f0}
    .small{font-size:13px;color:var(--muted)}
    .status{margin-top:8px;color:var(--muted);font-weight:600}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
    /* mobile friendly */
    @media(min-width:900px){ #map{height:300px} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">R</div>
      <div>
        <h1>RoadRiskLive</h1>
        <div class="small">Realtime road condition & risk monitoring ‚Äî demo</div>
      </div>
    </header>

    <div id="map" aria-hidden="false"></div>

    <div class="controls">
      <button id="reportBtn">üìç Report my location</button>
      <button id="startBtn" class="btn-primary">‚ñ∂Ô∏è Start live sensors</button>
      <button id="stopBtn" disabled>‚èπ Stop sensors</button>
      <button id="centerBtn">üìå Center map</button>
    </div>

    <div class="panel">
      <div class="small">Live data ¬∑ Local demo</div>
      <div id="lastPushed" class="status">Last pushed: ‚Äî</div>

      <div style="margin-top:12px">
        <div class="live-row"><div class="label">Risk Score</div><div id="risk" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Acceleration</div><div id="acc" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Pothole</div><div id="pothole" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Rough</div><div id="rough" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Visibility</div><div id="vis" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Timestamp</div><div id="ts" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Lat</div><div id="lat" class="value">‚Äî</div></div>
        <div class="live-row"><div class="label">Lon</div><div id="lon" class="value">‚Äî</div></div>
      </div>

      <div class="summary">
        <div class="small">Quick interpretation</div>
        <table>
          <tr data-metric="Risk"><th>Risk Score</th><td class="value">0 = safe</td></tr>
          <tr data-metric="Acceleration"><th>Acceleration</th><td class="value">High ‚âà bump/impact</td></tr>
          <tr data-metric="Pothole"><th>Pothole</th><td class="value">Counts potholes reported: No</td></tr>
          <tr data-metric="Rough"><th>Rough</th><td class="value">Surface roughness flag: No</td></tr>
          <tr data-metric="Visibility"><th>Visibility</th><td class="value">1 (low) ‚Üí 5 (good)</td></tr>
        </table>
      </div>
    </div>
  </div>

  <script>
  /* ---------- SIMPLE DEMO SCRIPT ----------
     Purpose: give you a file where map + buttons definitely work.
     This does NOT push to your DB. It logs actions clearly into console.
  */

  console.log('[RR] demo script loaded');

  const el = id => document.getElementById(id);

  // --- init map & marker
  let map = L.map('map', { zoomControl: true }).setView([28.45006, 77.58585], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '¬©Ô∏è OpenStreetMap'
  }).addTo(map);
  let marker = L.circleMarker([28.45006, 77.58585], { radius:10, color: '#168a46', fillColor:'#168a46', fillOpacity:1 }).addTo(map);

  // UI helpers
  const setText = (id, t) => { const e = el(id); if(e) e.innerText = t; };

  // sensor handling
  let motionHandler = null;
  let sensorsRunning = false;

  function setButtonsRunning(r){
    sensorsRunning = r;
    el('startBtn').disabled = r;
    el('stopBtn').disabled = !r;
  }

  // utility: set multiple UI fields from a payload
  function updateUIFromPayload(p){
    setText('risk', p.risk ?? '‚Äî');
    setText('acc', (p.acceleration !== undefined) ? String(p.acceleration) : '‚Äî');
    setText('pothole', p.pothole ? 'Yes' : 'No');
    setText('rough', p.rough ? 'Yes' : 'No');
    setText('vis', p.visibility ?? '‚Äî');
    setText('ts', p.timestamp ?? '‚Äî');
    setText('lat', (p.lat !== undefined) ? p.lat.toFixed(6) : '‚Äî');
    setText('lon', (p.lon !== undefined) ? p.lon.toFixed(6) : '‚Äî');
  }

  // Start live sensors
  async function startLiveSensors(){
    console.log('[RR] startLiveSensors() called');
    setButtonsRunning(true);
    setText('lastPushed','Getting sensors...');

    // iOS device motion permission (works only if user gesture)
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const perm = await DeviceMotionEvent.requestPermission();
        console.log('[RR] DeviceMotion permission:', perm);
        if (perm !== 'granted') {
          alert('Motion permission not granted ‚Äî motion data will be disabled.');
        }
      } catch (err) {
        console.warn('[RR] DeviceMotion request error', err);
      }
    }

    // attach motion handler (best-effort)
    motionHandler = (ev) => {
      try {
        const ax = ev.acceleration?.x ?? ev.accelerationIncludingGravity?.x ?? 0;
        const ay = ev.acceleration?.y ?? ev.accelerationIncludingGravity?.y ?? 0;
        const az = ev.acceleration?.z ?? ev.accelerationIncludingGravity?.z ?? 0;
        const acc = Math.sqrt(ax*ax + ay*ay + az*az);
        // update only acceleration field and interpretation table
        updateUIFromPayload({ acceleration: Number(acc.toFixed(2)) });
        console.log('[RR] motion acc=', acc);
      } catch(e){ console.warn('[RR] motion handler error', e); }
    };
    window.addEventListener('devicemotion', motionHandler);

    // get geolocation once and update UI + marker
    if (!navigator.geolocation) {
      alert('Geolocation not supported in this browser');
      setText('lastPushed','No geolocation');
      return;
    }
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      console.log('[RR] got geo', lat, lon);
      marker.setLatLng([lat,lon]);
      map.setView([lat,lon], 16);
      const payload = {
        timestamp: new Date().toISOString(),
        lat, lon,
        acceleration: 0,
        pothole:false, rough:false, visibility:5, risk:0
      };
      updateUIFromPayload(payload);
      setText('lastPushed','Simulated push at ' + payload.timestamp);
    }, (err) => {
      console.warn('[RR] geolocation error', err);
      setText('lastPushed','Geo error: '+ (err.message||err.code));
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:10000 });
  }

  function stopLiveSensors(){
    console.log('[RR] stopLiveSensors() called');
    if (motionHandler) window.removeEventListener('devicemotion', motionHandler);
    motionHandler = null;
    setButtonsRunning(false);
    setText('lastPushed','Stopped');
  }

  function reportMyLocation(){
    console.log('[RR] reportMyLocation() called');
    if (!navigator.geolocation) { alert('No geolocation'); return; }
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const payload = { timestamp: new Date().toISOString(), lat, lon };
      // show simple UI update (no DB in this demo)
      marker.setLatLng([lat,lon]);
      map.setView([lat,lon], 16);
      updateUIFromPayload({ timestamp: payload.timestamp, lat, lon });
      setText('lastPushed','Reported location: ' + payload.timestamp);
      console.log('[RR] reported payload (demo only)', payload);
    }, (err) => { console.warn('[RR] report geo error', err); alert('Location failed: ' + (err.message||err.code)); }, { enableHighAccuracy:true });
  }

  function centerMap(){
    console.log('[RR] centerMap()');
    const lat = parseFloat(el('lat').innerText) || 28.45006;
    const lon = parseFloat(el('lon').innerText) || 77.58585;
    map.setView([lat,lon], 16);
  }

  // wire buttons
  el('startBtn').addEventListener('click', startLiveSensors);
  el('stopBtn').addEventListener('click', stopLiveSensors);
  el('reportBtn').addEventListener('click', reportMyLocation);
  el('centerBtn').addEventListener('click', centerMap);

  // initial UI
  setText('lastPushed','‚Äî');
  console.log('[RR] demo UI wired ‚Äî ready.');
  </script>
</body>
</html>